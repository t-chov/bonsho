# bonsho

Chrome Extension for mindful screen time management. Combines the "mindful interruption" concept (like One Sec) with usage time tracking (like StayFocusd).

## Tech Stack

- **WXT 0.20** + **React 19** for Chrome Extension bundling
- **TypeScript**
- **Chrome Manifest V3** (auto-generated by WXT from `wxt.config.ts` + entrypoint definitions)

## Directory Structure

```
bonsho/
  wxt.config.ts              # WXT config + manifest settings
  tsconfig.json
  package.json
  public/
    icon/{16,32,48,96,128}.png  # Extension icons
  utils/
    types.ts                 # Type definitions
    constants.ts             # Target sites, defaults, alarm name
    storage.ts               # browser.storage.local helpers
    export.ts                # JSON/CSV export + file download
  entrypoints/
    background.ts            # Service worker (defineBackground)
    content.ts               # Content script (defineContentScript)
    popup/
      index.html             # Popup HTML entry
      main.tsx               # React mount point
      App.tsx                # Popup UI (React component)
      style.css              # Popup styles
```

## Development Commands

```bash
pnpm install         # Install dependencies
pnpm dev             # Start dev server (load .output/chrome-mv3/ as unpacked extension)
pnpm build           # Production build
pnpm compile         # TypeScript type check (tsc --noEmit)
```

## Coding Style & Tooling

### Linting & Formatting

This project uses **Biome** for linting and formatting:

```bash
pnpm lint          # Check for linting errors
pnpm lint:fix      # Fix auto-fixable linting errors
pnpm format        # Format all files
pnpm check         # Run full quality check (lint + typecheck + tests)
```

### Code Style Rules

- **Indentation**: 2 spaces
- **Line width**: 100 characters maximum
- **Quotes**: Single quotes for strings
- **Semicolons**: Always required
- **Trailing commas**: Always (for cleaner diffs)
- **Import organization**: Automatic via Biome
- **Import types**: Use `import type` for type-only imports

### JSDoc Requirements

**All functions, classes, and modules must have JSDoc comments in Japanese.**

#### Required Elements:
- Function/module purpose description
- `@param` with type and description for all parameters
- `@returns` with type and description for return values
- `@type` or `@typedef` for constants and type definitions

#### Format Examples:

```typescript
/**
 * 関数の説明を簡潔に記述
 * @param {string} site - サイトドメイン
 * @param {number} seconds - 加算する秒数
 * @returns {Promise<void>}
 */
async function addUsage(site: string, seconds: number): Promise<void> {
  // ...
}

/**
 * リマインダーアラーム名
 * @type {string}
 */
export const ALARM_NAME = "bonsho-reminder";
```

#### Component Documentation:

```typescript
/**
 * コンポーネントの目的と機能を説明
 * @returns {JSX.Element} レンダリングされるUI要素
 */
function MyComponent() {
  /**
   * ボタンクリック時の処理
   * @returns {Promise<void>}
   */
  const handleClick = async () => {
    // ...
  };

  return <button onClick={handleClick}>Click</button>;
}
```

### Development Workflow

1. Write code with JSDoc comments in Japanese
2. Run `pnpm check` before committing to verify quality
3. Run `pnpm format` to auto-format code if needed
4. All touched functions must have updated or added JSDoc

## Architecture

### Data Flow

1. **Content Script** (`content.ts`): Runs on target SNS/video sites. Sends a `HEARTBEAT` message to the background every 10 seconds.
2. **Background Service Worker** (`background.ts`): Receives heartbeats and accumulates usage time in `browser.storage.local`. Schedules `browser.alarms` at the configured interval. When an alarm fires, checks if the active tab is on a monitored site and sends `SHOW_WARNING` to the content script.
3. **Content Script overlay**: On receiving `SHOW_WARNING`, displays a full-screen zen-themed overlay with an "I understand" dismiss button.
4. **Popup** (`popup/App.tsx`): React component. Reads settings and usage from storage via `useState`/`useEffect`. Allows toggling enabled/disabled, changing the reminder interval, selecting monitored sites, and exporting data.

### Storage Format

- **Settings**: `browser.storage.local["settings"]` -> `BonshoSettings` object
- **Usage**: `browser.storage.local["usage"]` -> `{ "YYYY-MM-DD|site": seconds }` flat record

### Message Types

- `HEARTBEAT { site }` — Content -> Background (every 10s)
- `SHOW_WARNING` — Background -> Content (on alarm)

## WXT-Specific Notes

- **`browser` auto-import**: `browser` is auto-imported only in `entrypoints/`. Files in `utils/` must use `import { browser } from 'wxt/browser'` explicitly.
- **Manifest generation**: WXT auto-generates `manifest.json` from `wxt.config.ts` and entrypoint definitions. No manual `manifest.json` file exists.
- **Path alias**: `@/` refers to the project root (e.g., `import { getSettings } from '@/utils/storage'`).
- **Icon paths**: Files in `public/icon/` are served at `/icon/` at runtime.
- **Build output**: `.output/chrome-mv3/` — load this directory as an unpacked extension.

## Testing

1. `pnpm dev` to start the dev server
2. Open `chrome://extensions` -> Enable Developer Mode -> "Load unpacked" -> select `.output/chrome-mv3/`
3. Visit a monitored site (YouTube, Twitter, etc.)
4. Set reminder interval to 1 minute for quick testing
5. Verify the overlay appears after the interval
6. Check popup shows accumulated usage time
7. Test JSON/CSV export buttons

## Notes

- The overlay is a gentle reminder, not a blocker. Users can always dismiss it.
- Usage data stays local in `browser.storage.local`.
